@page "/tools/subnet-calculator"
@inject ISubnetCalculator SubnetService
@inject ISnackbar Snackbar
@using Core.Models
@using Core.Interfaces
@using Core.Constants

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4"></MudBreadcrumbs>
    
    <MudPaper Elevation="4" Class="pa-6">
        <MudText Typo="Typo.h4" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Calculate" Class="mr-2" />
            Subnet Calculator
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">
            Visual VLSM calculator for network planning.
        </MudText>

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="ipAddress" Label="IP Address" Variant="Variant.Outlined" 
                             HelperText="e.g. 192.168.1.1" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Computer" />
            </MudItem>
            <MudItem xs="12" md="3">
                 <MudSelect T="int" Label="CIDR" @bind-Value="cidr" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    @for (int i = 1; i <= 32; i++)
                    {
                        <MudSelectItem Value="@i">/@i</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CalculateSubnet" 
                          FullWidth="true" Class="mt-2" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.Calculate" Class="mr-2" />
                    Calculate
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (subnetInfo != null)
        {
            <MudDivider Class="my-6" />
            
            <MudGrid>
                 <MudItem xs="12" md="6">
                    <MudList T="string" Dense="true" DisablePadding="true">
                        <MudListSubheader><strong>Address Info</strong></MudListSubheader>
                        <MudListItem>
                            <div class="d-flex justify-space-between">
                                <MudText>Network Address:</MudText>
                                <MudText Color="Color.Primary" Typo="Typo.subtitle1">@subnetInfo.NetworkAddress</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                             <div class="d-flex justify-space-between">
                                <MudText>Broadcast Address:</MudText>
                                <MudText Color="Color.Secondary" Typo="Typo.subtitle1">@subnetInfo.BroadcastAddress</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                             <div class="d-flex justify-space-between">
                                <MudText>Netmask:</MudText>
                                <MudText>@subnetInfo.Netmask</MudText>
                            </div>
                        </MudListItem>
                         <MudListItem>
                             <div class="d-flex justify-space-between">
                                <MudText>IP Class:</MudText>
                                <MudText>@subnetInfo.IpClass</MudText>
                            </div>
                        </MudListItem>
                    </MudList>
                </MudItem>

                <MudItem xs="12" md="6">
                     <MudList T="string" Dense="true" DisablePadding="true">
                        <MudListSubheader><strong>Host Range</strong></MudListSubheader>
                        <MudListItem>
                             <div class="d-flex justify-space-between">
                                <MudText>First Usable:</MudText>
                                <MudText>@subnetInfo.FirstUsableHost</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                             <div class="d-flex justify-space-between">
                                <MudText>Last Usable:</MudText>
                                <MudText>@subnetInfo.LastUsableHost</MudText>
                            </div>
                        </MudListItem>
                         <MudListItem>
                             <div class="d-flex justify-space-between">
                                <MudText>Total Hosts:</MudText>
                                <MudText>@subnetInfo.TotalHosts.ToString("N0")</MudText>
                            </div>
                        </MudListItem>
                         <MudListItem>
                             <div class="d-flex justify-space-between">
                                <MudText>Usable Hosts:</MudText>
                                <MudText Color="Color.Success" Typo="Typo.subtitle1">@subnetInfo.UsableHosts.ToString("N0")</MudText>
                            </div>
                        </MudListItem>
                    </MudList>
                </MudItem>
                
                <MudItem xs="12">
                     <MudText Typo="Typo.caption" Class="mud-text-secondary">@subnetInfo.BinaryNetmask</MudText>
                </MudItem>
            </MudGrid>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Dashboard", href: AppConstants.Routes.Dashboard, icon: Icons.Material.Filled.Dashboard),
        new BreadcrumbItem("Subnet Calculator", href: null, disabled: true, icon: Icons.Material.Filled.Calculate)
    };

    private string ipAddress = "192.168.1.1";
    private int cidr = 24;
    private SubnetInfo? subnetInfo;

    private void CalculateSubnet()
    {
        if (string.IsNullOrWhiteSpace(ipAddress) || !SubnetService.IsValidIp(ipAddress))
        {
            Snackbar.Add("Invalid IP Address", Severity.Warning);
            return;
        }

        try
        {
            subnetInfo = SubnetService.Calculate(ipAddress, cidr);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}
