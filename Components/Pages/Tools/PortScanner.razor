@page "/tools/port-scanner"
@inject IPortScannerService PortScannerService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4"></MudBreadcrumbs>
    
    <MudPaper Elevation="4" Class="pa-6">
        <MudText Typo="Typo.h4" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Scanner" Class="mr-2" />
            Port Scanner
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">
            Scan ports on an IP address to identify open services
        </MudText>

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="ipAddress" Label="IP Address" Variant="Variant.Outlined" 
                             HelperText="Enter target IP address" Required="true" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudNumericField @bind-Value="startPort" Label="Start Port" Variant="Variant.Outlined" 
                                Min="1" Max="65535" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudNumericField @bind-Value="endPort" Label="End Port" Variant="Variant.Outlined" 
                                Min="1" Max="65535" />
            </MudItem>
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                          OnClick="ScanPorts" Disabled="isScanning" FullWidth="true" Size="Size.Large">
                    @if (isScanning)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Scanning...</span>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Class="mr-2" />
                        <span>Start Scan</span>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (scanResult != null)
        {
            <MudDivider Class="my-6" />
            
            @if (scanResult.Success)
            {
                <MudAlert Severity="Severity.Success" Class="mb-4">
                    Scan completed! Found @scanResult.OpenPorts open ports out of @scanResult.TotalScanned scanned.
                </MudAlert>

                @if (scanResult.Results.Any())
                {
                    <MudTable Items="@scanResult.Results" Hover="true" Striped="true" Dense="true">
                        <HeaderContent>
                            <MudTh>Port</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Service</MudTh>
                            <MudTh>Response Time</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Port">@context.Port</MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">Open</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Service">@context.ServiceName</MudTd>
                            <MudTd DataLabel="Response Time">@context.ResponseTimeMs ms</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No open ports found in the specified range.</MudAlert>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Error">Error: @scanResult.ErrorMessage</MudAlert>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Dashboard", href: AppConstants.Routes.Dashboard, icon: Icons.Material.Filled.Dashboard),
        new BreadcrumbItem("Port Scanner", href: null, disabled: true, icon: Icons.Material.Filled.Scanner)
    };

    private string ipAddress = "";
    private int startPort = 80;
    private int endPort = 100;
    private bool isScanning = false;
    private PortScanBatchResult? scanResult;

    private async Task ScanPorts()
    {
        if (string.IsNullOrWhiteSpace(ipAddress) || !ipAddress.IsValidIpAddress())
        {
            Snackbar.Add("Please enter a valid IP address", Severity.Warning);
            return;
        }

        var validation = ValidationHelper.ValidatePortRange(startPort, endPort);
        if (!validation.IsValid)
        {
            Snackbar.Add(validation.ErrorMessage, Severity.Warning);
            return;
        }

        isScanning = true;
        scanResult = null;

        try
        {
            scanResult = await PortScannerService.ScanPortRangeAsync(ipAddress, startPort, endPort);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Scan error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isScanning = false;
        }
    }
}
