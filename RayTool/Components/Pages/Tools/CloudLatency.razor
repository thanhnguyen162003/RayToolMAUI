@page "/tools/cloud-latency"
@inject ILatencyService LatencyService
@inject ISnackbar Snackbar
@using Core.Models
@using Core.Interfaces

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4"></MudBreadcrumbs>
    
    <MudPaper Elevation="4" Class="pa-6">
        <MudText Typo="Typo.h4" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Cloud" Class="mr-2" />
            Cloud Latency Checker
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">
            Measure real-time latency to AWS, Azure, and Google Cloud regions.
        </MudText>

        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CheckLatency" Disabled="isChecking" Class="mb-4">
            @if (isChecking)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Checking...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Speed" Class="mr-2" />
                <span>Run Test</span>
            }
        </MudButton>

        @if (results.Any())
        {
            <MudTable Items="@results" Hover="true" Striped="true" SortLabel="Sort By">
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortBy="new Func<LatencyResult, object>(x => x.Region.Provider)">Provider</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<LatencyResult, object>(x => x.Region.Name)">Region</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<LatencyResult, object>(x => x.LatencyMs)">Latency (ms)</MudTableSortLabel></MudTh>
                    <MudTh>Status</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Provider">@context.Region.Provider</MudTd>
                    <MudTd DataLabel="Region">
                        <MudText>@context.Region.Name</MudText>
                        <MudText Typo="Typo.caption">@context.Region.Code</MudText>
                    </MudTd>
                    <MudTd DataLabel="Latency">
                        @if (context.LatencyMs >= 0)
                        {
                            <MudChip T="string" Color="@GetLatencyColor(context.LatencyMs)" Size="Size.Small">@context.LatencyMs ms</MudChip>
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.IsSuccess)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                        }
                        else
                        {
                            <MudTooltip Text="@context.StatusMessage">
                                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                            </MudTooltip>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Dashboard", href: AppConstants.Routes.Dashboard, icon: Icons.Material.Filled.Dashboard),
        new BreadcrumbItem("Cloud Latency", href: null, disabled: true, icon: Icons.Material.Filled.Cloud)
    };

    private bool isChecking = false;
    private List<LatencyResult> results = new();

    private async Task CheckLatency()
    {
        isChecking = true;
        results.Clear();
        
        try
        {
            var regions = await LatencyService.GetRegionsAsync();
            // Initialize with placeholder results
            results = regions.Select(r => new LatencyResult { Region = r, LatencyMs = -1, IsSuccess = false }).ToList();
            StateHasChanged(); // Show empty table

            // Running one by one for visual effect, but can be parallel
            // To stream updates, we update existing items in the list
            await foreach (var result in LatencyService.MeasureLatencyAsync(regions))
            {
                var index = results.FindIndex(r => r.Region.Code == result.Region.Code);
                if (index != -1)
                {
                    results[index] = result;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
             Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isChecking = false;
        }
    }

    private Color GetLatencyColor(long latency)
    {
        if (latency < 100) return Color.Success;
        if (latency < 300) return Color.Warning;
        return Color.Error;
    }
}
