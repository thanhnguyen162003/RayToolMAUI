@page "/tools/port-scanner"
@inject IPortScannerService PortScannerService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4"></MudBreadcrumbs>
    
    <MudPaper Elevation="4" Class="pa-6">
        <MudText Typo="Typo.h4" GutterBottom="true">
            <MudIcon Icon="@Icons.Material.Filled.Scanner" Class="mr-2" />
            Port Scanner
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">
            Scan ports on an IP address to identify open services
        </MudText>

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="ipAddress" Label="IP Address" Variant="Variant.Outlined" 
                             HelperText="Enter target IP address" Required="true" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudNumericField @bind-Value="startPort" Label="Start Port" Variant="Variant.Outlined" 
                                Min="1" Max="65535" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudNumericField @bind-Value="endPort" Label="End Port" Variant="Variant.Outlined" 
                                Min="1" Max="65535" />
            </MudItem>
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                          OnClick="ScanPorts" Disabled="isScanning" FullWidth="true" Size="Size.Large">
                    @if (isScanning)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Scanning...</span>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Class="mr-2" />
                        <span>Start Scan</span>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (isScanning)
        {
            <MudProgressLinear Color="Color.Primary" Value="@scanProgress" Class="my-4" />
            <MudText Typo="Typo.body2" Align="Align.Center">@currentStatus</MudText>
        }

        @if (openPorts.Any())
        {
            <MudDivider Class="my-6" />
            <MudText Typo="Typo.h6" Class="mb-4">Open Ports Found</MudText>
            
            <MudTable Items="@openPorts" Hover="true" Striped="true" Dense="true" Elevation="2">
                <HeaderContent>
                    <MudTh>Port</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Service</MudTh>
                    <MudTh>Response Time</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Port">@context.Port</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Open</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Service">@context.ServiceName</MudTd>
                    <MudTd DataLabel="Response Time">@context.ResponseTimeMs ms</MudTd>
                </RowTemplate>
            </MudTable>
        }
        else if (!isScanning && scanCompleted)
        {
             <MudDivider Class="my-6" />
             <MudAlert Severity="Severity.Info">Scan completed. No open ports found in the specified range.</MudAlert>
        }
        
        <MudExpansionPanels Class="mt-4">
            <MudExpansionPanel Text="Scan Log">
                <div style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem;">
                    @foreach (var log in scanLogs)
                    {
                        <div class="@log.LogClass">@log.Message</div>
                    }
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Dashboard", href: AppConstants.Routes.Dashboard, icon: Icons.Material.Filled.Dashboard),
        new BreadcrumbItem("Port Scanner", href: null, disabled: true, icon: Icons.Material.Filled.Scanner)
    };

    private string ipAddress = "";
    private int startPort = 80;
    private int endPort = 100;
    private bool isScanning = false;
    private bool scanCompleted = false;
    private double scanProgress = 0;
    private string currentStatus = "Ready to scan";
    private List<PortScanResult> openPorts = new();
    private List<ScanLogItem> scanLogs = new();

    private class ScanLogItem
    {
        public string Message { get; set; } = "";
        public string LogClass { get; set; } = "";
    }

    private async Task ScanPorts()
    {
        if (string.IsNullOrWhiteSpace(ipAddress) || !ipAddress.IsValidIpAddress())
        {
            Snackbar.Add("Please enter a valid IP address", Severity.Warning);
            return;
        }

        var validation = ValidationHelper.ValidatePortRange(startPort, endPort);
        if (!validation.IsValid)
        {
            Snackbar.Add(validation.ErrorMessage, Severity.Warning);
            return;
        }

        // Reset state
        isScanning = true;
        scanCompleted = false;
        scanProgress = 0;
        openPorts.Clear();
        scanLogs.Clear();
        currentStatus = "Starting scan...";

        try
        {
            int totalPorts = endPort - startPort + 1;
            int processedCount = 0;

            await foreach (var result in PortScannerService.ScanPortsStreamAsync(ipAddress, startPort, endPort, concurrency: 50))
            {
                processedCount++;
                scanProgress = (double)processedCount / totalPorts * 100;
                currentStatus = $"Scanning port {result.Port}...";

                string logMsg = $"Checked port {result.Port}: {(result.IsOpen ? "OPEN" : "CLOSED")}";
                string cssClass = result.IsOpen ? "mud-success-text font-weight-bold" : "mud-text-secondary";
                
                // Keep log size reasonable
                if (scanLogs.Count > 100) scanLogs.RemoveAt(0);
                scanLogs.Add(new ScanLogItem { Message = logMsg, LogClass = cssClass });

                if (result.IsOpen)
                {
                    openPorts.Add(result);
                    // Force UI update for found ports immediately
                    StateHasChanged();
                }

                if (processedCount % 10 == 0)
                {
                    StateHasChanged();
                }
            }

            scanCompleted = true;
            currentStatus = "Scan completed!";
            Snackbar.Add($"Scan finished. Found {openPorts.Count} open ports.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Scan error: {ex.Message}", Severity.Error);
            scanLogs.Add(new ScanLogItem { Message = $"ERROR: {ex.Message}", LogClass = "mud-error-text" });
        }
        finally
        {
            isScanning = false;
        }
    }
}
